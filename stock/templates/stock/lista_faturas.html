{% extends "stock/base.html" %}
{% load i18n %}
{% load l10n %}
{% load humanize %}

{% block title %}{% trans "Histórico de Faturas" %}{% endblock %}

{% block content %}
    <h1 class="mb-4">{% trans "Histórico de Faturas" %}</h1>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{% url 'lista_faturas' %}" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="q_numero" class="form-label">{% trans "Nº Fatura" %}</label>
                    <input type="text" name="q_numero" id="q_numero" class="form-control" value="{{ request.GET.q_numero }}">
                </div>
                <div class="col-md-3">
                    <label for="q_cliente" class="form-label">{% trans "Nome do Cliente" %}</label>
                    <input type="text" name="q_cliente" id="q_cliente" class="form-control" value="{{ request.GET.q_cliente }}">
                </div>
                <div class="col-md-2">
                    <label for="q_data" class="form-label">{% trans "Data de Emissão" %}</label>
                    <input type="date" name="q_data" id="q_data" class="form-control" value="{{ request.GET.q_data }}">
                </div>
                <div class="col-md-2">
                    <label for="q_paga" class="form-label">{% trans "Estado" %}</label>
                    <select name="q_paga" id="q_paga" class="form-select">
                        <option value="" {% if not request.GET.q_paga %}selected{% endif %}>Todos</option>
                        <option value="sim" {% if request.GET.q_paga == 'sim' %}selected{% endif %}>Paga</option>
                        <option value="nao" {% if request.GET.q_paga == 'nao' %}selected{% endif %}>Não Paga</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> {% trans "Pesquisar" %}
                    </button>
                    <a href="{% url 'lista_faturas' %}" class="btn btn-secondary w-100 mt-2">
                        <i class="fas fa-eraser"></i> {% trans "Limpar" %}
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>{% trans "Nº Fatura" %}</th>
                            <th>{% trans "Cliente" %}</th>
                            <th>{% trans "Criação" %}</th>
                            <th>{% trans "Criado por" %}</th>
                            <th>{% trans "Modificação" %}</th>
                            <th>{% trans "Modificado por" %}</th>
                            <th class="text-end">{% trans "Valor a Pagar" %}</th>
                            <th class="text-center">{% trans "Paga" %}</th>
                            <th class="text-end">{% trans "Ações" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fatura in page_obj %}
                            <tr>
                                <td><a href="{% url 'detalhe_fatura' fatura.id %}"><strong>{{ fatura.numero_fatura }}</strong></a></td>
                                <td>{{ fatura.cliente.nome }}</td>
                                <td>{{ fatura.criado_em|date:"d/m/Y H:i" }}</td>
                                <td>{{ fatura.utilizador.username|default:"N/A" }}</td>
                                <td>{% if fatura.foi_modificada %}{{ fatura.atualizado_em|date:"d/m/Y H:i" }}{% else %}<span class="text-muted">--</span>{% endif %}</td>
                                <td>{% if fatura.modificado_por %}{{ fatura.modificado_por.username }}{% else %}<span class="text-muted">--</span>{% endif %}</td>
                                <td class="text-end fw-bold">{{ fatura.valor_a_pagar|floatformat:2|intcomma }} CFA</td>
                                <td class="text-center">
                                    <form action="{% url 'toggle_fatura_paga' fatura.id %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm px-2 py-1 {% if fatura.paga %}btn-success{% else %}btn-danger{% endif %}">
                                            {% if fatura.paga %}{% trans "Sim" %}{% else %}{% trans "Não" %}{% endif %}
                                        </button>
                                    </form>
                                </td>
                                <td class="text-end"><a href="{% url 'editar_fatura' fatura.id %}" class="btn btn-warning btn-sm">{% trans "Editar" %}</a></td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="9" class="text-center">{% trans "Nenhuma fatura encontrada." %}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if page_obj.has_other_pages %}
                 {% with request.GET.urlencode as params %}{% include 'stock/pagination.html' with params=params %}{% endwith %}
            {% endif %}
        </div>
    </div>
{% endblock %}